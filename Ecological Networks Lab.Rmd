---
title: "Ecological Networks Lab"
output: html_document
date: '2022-12-08'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Ecological Networks Lab

Session: Afternoon, Day 2 from 3:30 - 6:30 PM

By: Sophia Simon, Daniel Valencia, Kayla Hale, Isidora √Åvila-Thiem

Oceans are facing a crisis worldwide, with fish stocks and marine ecosystems collapsing due to anthropogenic stressors including fisheries exploitation and climate change. The field of ecological networks can contribute to understanding how the perturbations caused by those stressors propagate through marine ecosystems by analyzing the structure and dynamics of networks of species interactions.

This aim of this lab is to introduce a code base for analyzing the effects of perturbation from environmental or anthropogenic stressors, that may result in the extinction of marine organisms. Specific focus is placed on how these extinctions may propagate through a food web and impact static network metrics. We extend this analysis to dynamic network metrics in the lab's final reflection, where we also recommend additional resources.

{Introduction/power-point 30 minutes}

### Section 1 - Introduction to networks approach & basic concepts

#### Loading packages and data

```{r Load packages and data}

#install the R package "NetworkExtinction"

#load packages
library("NetworkExtinction")
library("ggplot2")
library("network")
library("igraph")

#define simple example network
example_matrix <- read.csv("/Users/sophiasimon/Desktop/exnet.csv",header = FALSE)
example_matrix <- as.matrix(example_matrix)

#load chilean intertidal network
data("chilean_intertidal")

#code to convert between matrix and network formats
intertidal_matrix <- as.matrix(chilean_intertidal)
intertidal_network <- as.network(chilean_intertidal)

#Code to visualize networks (Daniel can try to do this)
```

#### Calculating and visualizing important network metrics (\~45 minutes)

Below are important definitions relevant to the NetworkExtinction R package workflows (NextR package preprint, Valdovinos 2019 Box 1). Read through these definitions and complete the exercises and reflections that follow each definition. NOTE: For each exercise, begin by manipulating the simple example network called `example_matrix` before moving on to the empirical network called `intertidal_matrix`. Remember that the example matrix is the same one shown in the presentation slides. For these exercises, it may help to draw out the example matrix and preform manipulations by hand on pen & paper.

**Interaction Type** - a link between two nodes reflecting the type of relationship involved. The NetworkExtinction R package handles mutualistic (+/+) and trophic / parasitic (-/+) interaction types. For a more exhaustive overview of interaction types, consult Morales-Castilla et al. (2015).

Reflection 1.1. Interaction type greatly impacts how links between nodes are interpreted biologically and subsequently impact the consequences of loss of connections in extinction cascades. Brainstorm how the loss of links/isolation of nodes relates to extinction in trophic versus mutualistic networks. How might outcomes differ between basal species/consumer nodes and facultative/obligate links?

**Species Richness (S)** -- Total number of species in the network.

```{r Exercise 1.1}

# Calculate the total number of species in the Chilean network
S <- nrow(example_matrix)

#Now calculate this metric for the empirical intertidal network

```

**Degree** - The number of links that connects a single node to the rest of the networks. Total degree includes in-degrees (e.g. resource links) and out-degrees (e.g. consumer links).

```{r Exercise 1.2}

#Calculate the in-degree, out-degree, and total degree for species 10 in the example network

in_degree_10 <- sum(example_matrix[,10]) #columns, resources of that node
out_degree_10 <- sum(example_matrix[10,]) #rows, consumers of that node
total_degree_10 <- in_degree_10 + out_degree_10

#Now calculate the in-degree, out-degree, and total degree for species #29 and species #64 in the Chilean intertidal network. 
```

Reflection 1.2. Reflect on your calculations from Part 2 of Exercise 1.2 (above) to describe what the in_degree and out_degree metrics can tell you about the characteristic of a particular species, or, the positioning of a specific node in the food web? In other words, what did we learn about species 29 and 64?

**Primary Extinction --** Primary extinction refers to the direct removal of a species from the food web. Mechanisms behind primary extinction can include habitat loss, over harvesting, competition with invasive species, etc.

**Secondary Extinction** -- Secondary extinction captures the indirect effects of a primary extinction, which cascade through the food web. Secondary extinction occurs when all of a species' resource items go extinct, leaving the species with nothing to consume.

Reflection 1.3. Reflect on how secondary extinction relates to the in-degree, out-degree, and total degree metrics. Is it necessary for a node's total degree to equal zero in order for a secondary extinction to occur?

Reflection 1.4. Reflect on what might make some species more vulnerable to secondary extinction than others? For example, if species 1 has a higher in-degree than species 2, which one is more vulnerable to extinction?

**Link density** -- The number of links divided by the number of species in the network, link density = L/S. This metric can also be thought of as the average number of links per species in the network.

**Connectance (C)** -- Fraction of potential interactions that are realized, C=L/S^2^ where L is the total number of realized interactions (links connecting species) and is the S^2^ total number of possible links in the network (realized if every species interacts with every other species)

```{r Exercise 1.3}

L <- sum(example_matrix)
C <- L/S^2

#Now calculate this metric for the empirical intertidal network

```

**Degree Distribution** -- The degree distribution is the probability distribution that a node in the network is connected to k other nodes (Estrada, 2007). In the figure below (Lee, 2018) you can see an example of two degree distributions. (Left) Shows a network with a random degree distribution, where all nodes have approximately the same number of links. (Right) Shows a network with a highly skewed distribution, where most nodes have few interactions and a few nodes have many interactions.

![](images/Screen%20Shot%202022-12-29%20at%206.30.33%20PM.png){width="435"}

In the NExt R package, the `DegreeDistribution()` function calculates the cumulative distribution of the number of links that each species in the food network has (Estrada 2007). Then, the observed distribution is fitted to the exponential, and power law models.

```{r Calculating important metrics}

DegreeDistribution(example_matrix,scale="arithmetic")

#Now calculate this metric for the empirical intertidal network

```

Reflection 1.3. Degree distribution captures information about the probability of a species interacting with other species. Reflect on how this probability affects secondary extinction risk. If you remove a species from a network with a random degree distribution, versus one with a highly skewed degree distribution, how would you expect secondary extinctions to cascade through the rest of the network. Is one degree distribution more vulnerable to secondary extinction than another?

### Part 2. Examples & Interpretation

#### Simulating network extinctions (\~20 minutes)

For this lab, we are going to focus on one extinction scenario - extinction of most-connected nodes. Resultant network metrics, after extinction of most-connected nodes are assigned to the `Output` variable which contains columns Spp (num. identity of the extinct species), S (number of species), L (number of links), C (network connectance), Link_density (L/S), SecExt (number of secondary extinctions), NumExt (number of primary extinctions that have occurred), TotalExt (cumulative total number of extinction that have occurred, including primary and secondary extinctions).

```{r}

Mostconnected <- SimulateExtinctions(Network = chilean_intertidal, Method = "Mostconnected",
NetworkType = "Trophic", # default argument
IS = 0, # default argument
Rewiring = FALSE # default argument
)

Output <- Mostconnected$sims
#indexing the Output variable for most relevant network metrics. If you are curious, you will have time to explore additional metrics during independent work.
Output[c("Spp","S","L","C","Link_density","SecExt","NumExt","TotalExt")]
ExtinctionPlot(Mostconnected$sims)
```

Reflection 2.x. Reflecting on the `ExtinctionPlot` , what do you notice about the effect of cumulative primary extinctions on the overall network? Does anything surprise you about the network's response to extinction of its most-connected species? More specifically, does the network appear to be highly vulnerable to extinction or does it appear to be robust?

Reflection 2.x. Depending on your answer to the previous reflection, brainstorm some ecological mechanisms that might underlie the observed result. What species traits or network properties might explain the network's vulnerability or robustness to extinction?

#### Testing hypotheses for network robustness (\~25 minutes)

To further develop your ideas from Reflection 2.x, use the code below to assess different properties of the Chilean intertidal network that might underlie or explain the observed response to primary extinction.

```{r}

#generalism

#redundancy

#trophic levels

#omnivory --> non-integer trophic level

#number of herbivores, omnivores, etc

#species traits / Isidora's characteristics sheet (plotting in ggplot)

#Hypothesis testing --> remove the species that you believe are responsible for network robustness from the network. Then, re-run the code simulating network extinctions. Do you observe a decrease in robustness? 
```

Looking at the figure, we're removing most to least connected species. Even with that, the network is very robust. Good reflection b/c you can integrate ecological concepts. In the intertidal, it's because there's a lot of omnivory with highly generalist and redundant interactions. This is one reason why this network is so robust. In the Scientific Reports paper, there is a section where they discuss why the network is so robust.

(Kayla) Prompt students to think about what would make a network robust. Pose hypotheses, run the code, think through what they find. (Daniel) Also useful to have more visual aid if they want to make some conclusions regarding robustness. They should also look at the network and trophic level. If robustness is related to the amount of herbivores there are, you should look at the herbivores. Maybe make a summary of the matrix that allows to show amount of herbivores, omnivores, etc. Can use Isidora's characteristics sheet for this. Add a line of code in which we show how to plot in ggplot (plot different columns, beyond secondary extinctions using ggplot).

(Kayla) relative generalism of species will me helpful in drawing the conclusions that Isidora came to for Reflection 2.x. relate to degree. could be as simple as saying omnivore is any species that has a non-integer trophic level. plotting trophic level vs degree.

Guiding questions/instructions for them to explore some metric. Ordered extinctions could be for hypothesis testing.

Hypothesis: robustness comes from omnivores so remove omnivores and see what happens?

All specialists depend on plankton. Very sensitive to removal of plankton. These could be two hypotheses/exercises.

Reflection 2.1. Brainstorm examples of biological mechanisms that would lead to the 3 extinction scenarios considered in this package: extinction of most-connected species or random extinctions.

#### Visualization and comparison

```{r}

ExtinctionPlot(Mostconnected$sims)

ExtinctionPlot(History = Mostconnected$sims, Variable = "Link_density")

CompareExtinctions(Nullmodel = Random_MC, Hypothesis = Mostconnected)

CompareExtinctions(Nullmodel = Random_OR, Hypothesis = Ordered)
```

### Part 3. Independent work (\~30 minutes)

-   Goal: developing tools for conservation. how can this be useful for conservation, strategy, etc? careful when making predictions. Use Friday afternoon to have a second lab session/open office hour.

-   Independent work: reading papers, continuing with activities part 2.2 and 2.3, developing a small project centering tools for conservation.

-   Sergio book chapter. Use ecological networks for ecosystem management. Isidora also a collaborator on this work.

#### (OPTIONAL) Ordered extinctions

```{r}
Order <- order(sna::degree(chilean_intertidal, cmode = "outdegree"),
                  decreasing = TRUE)[1:60]

Ordered <- SimulateExtinctions(Network = chilean_intertidal, Method = Ordered, Order = Order, NetworkType = "Trophic", # default argument
IS = 0, # default argument
Rewiring = FALSE # default argument
)
                
Ordered$sims   
ExtinctionPlot(Ordered$sims)
```

Optional exercise. Brainstorm biological mechanisms that would lead to specific sequences of ordered extinctions. Some examples are extinction of primary producers due to low nutrient subsidy or extinction of mollusks, due to ocean acidification. Try to implement those ordered extinction sequences into the code by redefining the `Order` variable.

#### (OPTIONAL) Random extinctions

Random

```{r}

Random_MC <- RandomExtinctions(Network = chilean_intertidal, nsim = 10,
                               #parallel = TRUE, ncores = 4,
                               Record = FALSE, plot = TRUE)

Random_OR <- RandomExtinctions(Network = chilean_intertidal, nsim = 10,
                               SimNum = length(Order),
                               #parallel = TRUE, ncores = 4,
                               Record = FALSE, plot = TRUE)

Random$sims   
ExtinctionPlot(Random$sims)
```

Note: If you would like to run the code chunk above at higher `nsim` values, you may want to consider running the code in parallel. To do this, you may uncomment the second line and make sure you input the right number of cores for your specific computer.

#### (OPTIONAL) Introducing extinction thresholds

By default, the functions in *NetworkExtinction* assume that, for a secondary extinction to happen, a node needs to lose all connections to its prey. However, one may also want to assume that species are only capable of sustaining existence given a threshold of remaining interaction strengths.

#### (OPTIONAL) Introducing rewiring potential

Ecological networks aren't static and we should assume that species may shift their connections in response to extinctions of an association/interaction partner. Rewiring processes can be simulated with *NetworkExtinction* using the `RewiringDist` argument.

Below, we call a matrix that contains information about similarities or rewiring potential of species indexed by columns to those indexed by rows.

```{r}

## use the functional group column from species characteristics spreadsheet to inform rewiring? 
```

### Part 4. Synthesis & Reflection (\~30 minutes)

#### Connecting oceanography and ecology (10 minutes - think, pair, share)

Reflect on the connection between labs 1 & 2 --- this means directly thinking about the effects of physical oceanographic variables like ocean currents, temperature, salinity, etc. on ecological variables like recruitment, life history, dispersal, species interactions, etc.

One example of an the oceanographic phenomenon that occurs on the coast of Chile and California is upwelling. Upwelling is the wind-driven movement of cold, nutrient-rich water from the ocean depth to its surface, replacing the warm and nutrient-depleted water near the surface. This upward flux of waters results in a persistent supply of nutrients that fuels photosynthesis and accounts for high levels of productivity.

Reflection 4.1. Take a moment to hypothesize about the effects of upwelling on ecological variables. Which ecological variables would you expect to be impacted the most, and how might that change propagate through the ecological network?

(could be very well connected with the exercise, if you remove the plankton node there is a lot of extinction when you remove plankton and in the paper you see plankton perturbation associated with climate change and changes in the level of nutrients due to changes in upwelling. Very good connection! Careful talking about near-shore vs off-shore plankton dynamics, because they are different. )

Reflection 4.2. Brainstorm other examples of oceanographic phenomena that may impact ecological variables and how. How do you hypothesize that climate change may alter this oceanographic phenomenon and how might that change propagate through the ecological network?

#### Static vs dynamic networks (10 minutes - think, pair, share)

Static network metrics represent a subset of the tools available in network analysis -- and the next step involves incorporating ecological dynamics.

Reflection 4.3.

Reflection 4.4

Curtsdotter (2011) Robustness to secondary extinctions: Comparing trait-based sequential deletions in static and dynamic food webs

#### Reflection 4.3 -- Network methods as a tool for conservation (10 minutes - think, pair, share)

Reflection 4.5.

Reflection 4.6.

Sergio, Isidora book chapter.
